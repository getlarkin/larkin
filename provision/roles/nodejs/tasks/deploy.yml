- name: remove old repository
  shell: "[ $(ls -d /opt/larkin/releases/* | wc -l) -gt 3 ] && ls -d /opt/larkin/releases/* | head -1 | xargs rm -rf; true"
- name: get source code
  git:
    repo: https://github.com/getlarkin/larkin.git
    dest: /opt/larkin/releases/{{ ansible_date_time.iso8601_basic }}
    depth: 1
    accept_hostkey: True
- name: commands
  command: "{{ item }}"
  args:
    chdir: /opt/larkin/releases/{{ ansible_date_time.iso8601_basic }}
  with_items:
    - yarn install
    - cp .env.production packages/api/.env
    - cp .env.production .env
    - yarn db:migrate
    # - yarn db:seed
- name: link
  file:
    src: /opt/larkin/releases/{{ ansible_date_time.iso8601_basic }}
    dest: /opt/larkin/current
    state: link
